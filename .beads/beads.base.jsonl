{"id":"pretalx-1cu","content_hash":"0dad145fd165839b8eae4573f5dc732fc2419825f87b175b9bf757ec15dad673","title":"Create ActivityLog detail view with diff highlighting for before/after changes","description":"Create a detail view for individual ActivityLog entries that displays changed fields as a before/after diff with highlighting, particularly for long-form text fields like abstracts.","design":"**Current State:**\n- ActivityLog list shown in common/logs.html template\n- List view shows: timestamp, person, object, and log.display (action description)\n- No detail view exists for individual log entries\n- Log entries shown in:\n  - Dashboard (src/pretalx/orga/views/dashboard.py:244-247)\n  - Event history (src/pretalx/orga/views/event.py:278-285, template: orga/event/history.html)\n  - Submission history (src/pretalx/orga/views/submission.py:738-764, template: orga/submission/history.html)\n\n**Implementation:**\n\n1. **Create detail view:**\n   - Add EventHistory detail view in src/pretalx/orga/views/event.py (after line 285)\n   - Route: /orga/event/{event}/settings/history/{log_id}/\n   - Permission: require write permissions (matching parent list view)\n   - Template: orga/event/history_detail.html\n\n2. **Render change data:**\n   - Parse log.data['changes'] dict\n   - For each field show:\n     - Field name (human-readable label)\n     - Old value\n     - New value\n   - Handle different field types:\n     - Short text: inline before/after\n     - Long text (abstracts, descriptions): side-by-side or unified diff with highlighting\n     - I18nField: show changes for each locale\n     - ForeignKey: show related object representation\n     - FileField: show filename changes\n     - Boolean: yes/no representation\n\n3. **Diff highlighting:**\n   - Use difflib or similar for text comparison\n   - Highlight added (green), removed (red), unchanged (neutral)\n   - Consider using a library like difflib.HtmlDiff or implementing custom highlighting\n   - Make it work well for markdown-formatted text\n\n4. **Link from list views:**\n   - Modify common/logs.html template (currently at src/pretalx/common/templates/common/logs.html)\n   - Add link to detail view on log entries that have change data\n   - Only show link if user has write permissions\n   - Icon or \"view details\" link\n\n5. **Handle legacy data:**\n   - Show legacy log entries gracefully\n   - If data is just a flat dict (not with 'changes' key), show key-value pairs\n   - If legacy_data field is used, show notice that it's an old log format\n\n**UI Considerations:**\n- Make it clear what changed\n- For submissions with long abstracts, side-by-side view works better than inline\n- Use pretalx's existing CSS classes for consistency\n- Show empty/null values clearly (e.g., \"â€”\" or \"(empty)\")\n\n**Files to modify:**\n- src/pretalx/orga/views/event.py (add detail view)\n- src/pretalx/orga/urls.py (add route)\n- Create: src/pretalx/orga/templates/orga/event/history_detail.html\n- Modify: src/pretalx/common/templates/common/logs.html (add link)","acceptance_criteria":"- Detail view accessible at /orga/event/{event}/settings/history/{log_id}/\n- View requires write permissions\n- Changed fields shown with before/after values\n- Text diffs highlighted for readability\n- Long-form text displayed in readable format\n- I18n fields show changes per locale\n- Links from log list views work\n- Legacy log formats handled gracefully\n- Tests verify permission checking\n- Tests verify rendering of various field types","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-07T10:29:07.190906091+01:00","updated_at":"2025-11-07T19:10:05.630647828Z","closed_at":"2025-11-07T19:10:05.63065335Z","source_repo":".","dependencies":[{"issue_id":"pretalx-1cu","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:07.191902027+01:00","created_by":"daemon"},{"issue_id":"pretalx-1cu","depends_on_id":"pretalx-rob","type":"blocks","created_at":"2025-11-07T10:29:36.841707135+01:00","created_by":"daemon"}]}
{"id":"pretalx-9ra","content_hash":"19abd6c43cb02c87c8bc42a4900a997fe8a755b8ef0f9911d795ced4da4d2987","title":"Add history sidebar to CRUD detail views","description":"Add a sidebar to standard CRUD detail views showing the object's latest activity log entries, excluding submission detail views which have a dedicated history tab.","design":"**Current State:**\n- CRUDView in src/pretalx/common/views/generic.py:213-460 handles list/detail/create/update/delete\n- OrgaCRUDView subclass adds orga-specific behavior\n- Submission has separate history view at orga/submission/history.html (SubmissionHistory in src/pretalx/orga/views/submission.py:738)\n- No history shown on other detail views\n\n**Implementation:**\n\n1. **Add history to OrgaCRUDView:**\n   - Modify OrgaCRUDView (find it by grepping for 'class OrgaCRUDView')\n   - Add method get_history_context() that returns recent log entries\n   - Add to detail view's context if object has logged_actions method\n   - Limit to last 10-20 entries for sidebar\n\n2. **Update detail templates:**\n   - Find orga templates that extend base CRUD templates\n   - Add sidebar block showing history\n   - Use similar styling to common/logs.html but compact for sidebar\n   - Link to full history view if one exists\n\n3. **Exclude submissions:**\n   - Submission detail views already have history tab (line 738-768 in submission.py)\n   - Check if model is Submission and skip sidebar for those\n   - Or make it configurable via class attribute\n\n4. **Permission handling:**\n   - Only show history to users with write permissions\n   - Match permissions used in history views (see EventHistory permission_required)\n\n**Alternative approach:**\nInstead of modifying views, create a template tag that:\n- Takes an object\n- Returns HTML for compact history sidebar\n- Can be included in any detail template\n- Handles permission checking internally\n\nThis would be more flexible and easier to opt-in/out.\n\n**Files to check:**\n- src/pretalx/common/views/generic.py (OrgaCRUDView)\n- Search for templates extending orga CRUD bases\n- Look at how submission history tab is implemented","acceptance_criteria":"- Detail views for standard CRUD objects show history sidebar\n- Sidebar shows last 10-20 log entries\n- Only visible to users with write permissions\n- Submission detail views excluded (they have dedicated history tab)\n- Clicking entries links to detail view if available\n- Template tag or view mixin approach is clean and reusable\n- Tests verify permission handling\n- Tests verify history appears on appropriate views","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-07T10:29:07.604199838+01:00","updated_at":"2025-11-07T19:19:46.010233439Z","closed_at":"2025-11-07T19:19:46.010238081Z","source_repo":".","dependencies":[{"issue_id":"pretalx-9ra","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:07.605314994+01:00","created_by":"daemon"},{"issue_id":"pretalx-9ra","depends_on_id":"pretalx-1cu","type":"blocks","created_at":"2025-11-07T10:29:37.108446706+01:00","created_by":"daemon"}]}
{"id":"pretalx-c0w","content_hash":"b66ffa8c2996be78b6298e272e5ae98a269c8541937bc065e25121556f16c06a","title":"Log question answer changes on parent objects (submission/speaker/review)","description":"When question answers are modified, log the change action on the object the answer applies to (submission, speaker profile, or review) rather than on the Answer model itself.","design":"**Current State:**\n- Answer model in src/pretalx/submission/models/question.py:439-551\n- Answer.log_action() (line 543-551) already redirects log to parent object via content_object parameter\n- Answer has log_prefix = \"pretalx.submission.answer\" (line 448)\n- QuestionTarget enum (line 83-93) defines: SUBMISSION, SPEAKER, REVIEWER\n\n**Current Behavior:**\n- Answer.log_action() correctly determines content_object based on question target:\n  - SPEAKER target -\u003e logs to self.person (User/SpeakerProfile)\n  - SUBMISSION target -\u003e logs to self.submission\n  - REVIEWER target -\u003e logs to self.review\n- This is already implemented! (lines 544-550)\n\n**What's Missing:**\nThe logging is correctly targeted, but we need to ensure that when answers are saved via forms/API:\n1. The save/update captures before/after state (depends on pretalx-4)\n2. Form handling properly triggers logging with change data\n\n**Implementation:**\n\n1. **Find answer form handling:**\n   - QuestionsForm in src/pretalx/submission/forms (imported in submission views)\n   - Check how answers are saved in form.save()\n   - Ensure log_action is called with old/new data\n\n2. **Update API serializers:**\n   - Find answer serializers in src/pretalx/api/serializers/\n   - Ensure answer updates log to parent object with change tracking\n\n3. **Handle bulk answer saves:**\n   - When a submission form includes multiple question answers, they should be logged as one chunk on the submission\n   - This requires coordinating multiple answer saves\n\n**Key Insight from requirements:**\n\"This is part of the reason why we handle logging inside the view/form/API serializer than on the model, as we want to log changes as one chunk\"\n\nSo we need to:\n- Collect all answer changes in a form submission\n- Log them together as one entry on the parent object\n- Include what questions changed and their old/new values\n\n**Files to check:**\n- src/pretalx/submission/forms/ (QuestionsForm)\n- src/pretalx/api/serializers/question.py\n- src/pretalx/cfp/flow.py (submission flow that includes answers)","acceptance_criteria":"- Answer modifications via forms log to parent object (submission/speaker/review)\n- Answer modifications via API log to parent object\n- Multiple answer changes in one form save are logged as single entry\n- Log data includes which questions changed and their old/new values\n- Existing Answer.log_action() content_object logic preserved\n- Tests verify logging on correct parent objects\n- Tests verify bulk answer saves create single log entry","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-07T10:29:06.764225246+01:00","updated_at":"2025-11-07T12:04:52.877128678Z","closed_at":"2025-11-07T12:04:52.877128678Z","source_repo":".","dependencies":[{"issue_id":"pretalx-c0w","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:06.765219785+01:00","created_by":"daemon"},{"issue_id":"pretalx-c0w","depends_on_id":"pretalx-rob","type":"blocks","created_at":"2025-11-07T10:29:36.568286827+01:00","created_by":"daemon"}]}
{"id":"pretalx-g1e","content_hash":"71e92e2cdfa6ed90dd10053146cdcf9ebf5b4485e6d79b154f51460ff9a2e461","title":"Make submission history tab accessible to organizers with write/speaker permissions","description":"Update submission history view permissions to allow organizers with write access (and can_view_speakers) to view the history tab, not just administrators.","design":"**Current State:**\n- SubmissionHistory view in src/pretalx/orga/views/submission.py:738-768\n- Currently requires \"person.administrator_user\" permission (line 740)\n- This is very restrictive - only site administrators can see it\n- Template: orga/submission/history.html\n- Shows logged_actions() for the submission (line 764)\n\n**Requirements:**\n- Organizers with write access to submissions should see history\n- Additionally require can_view_speakers (though currently implicit)\n- This aligns with general submission management permissions\n\n**Implementation:**\n\n1. **Update permission:**\n   - Change permission_required from \"person.administrator_user\" to \"submission.orga_change_submission\"\n   - This matches write access for submissions\n\n2. **Check speaker visibility:**\n   - Add additional check for can_view_speakers if needed\n   - Though per requirements, this is \"currently implicit\" in write access\n   - May want to document this assumption\n\n3. **Consider what's visible:**\n   - Some log entries might contain sensitive speaker data\n   - Review if any filtering needed based on anonymized reviews\n   - See has_anonymised_review context (line 115-118)\n\n4. **Update history tab visibility:**\n   - The tab might be hidden if user lacks permission\n   - Find where submission tabs are defined\n   - Ensure history tab shows up for users with new permission level\n\n**Files to modify:**\n- src/pretalx/orga/views/submission.py:740 (permission_required)\n- Find where submission detail tabs are defined (search for tab definitions)\n- Possibly update submission/base.html template if tabs are there\n\n**Testing:**\n- Verify administrators still have access\n- Verify organizers with write access can see history\n- Verify reviewers without write access cannot see history\n- Verify history tab appears in navigation for permitted users","acceptance_criteria":"- Submission history view accessible to organizers with write access\n- Permission changed from administrator_user to appropriate orga permission  \n- can_view_speakers consideration documented or checked\n- History tab visible in submission navigation for permitted users\n- Administrators still have access\n- Reviewers without write access do not have access\n- Tests verify permission boundaries\n- No sensitive speaker data leaked in anonymized review contexts","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-07T10:29:08.004521061+01:00","updated_at":"2025-11-07T19:26:57.606547959Z","closed_at":"2025-11-07T19:26:57.606552511Z","source_repo":".","dependencies":[{"issue_id":"pretalx-g1e","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:08.006029562+01:00","created_by":"daemon"},{"issue_id":"pretalx-g1e","depends_on_id":"pretalx-1cu","type":"blocks","created_at":"2025-11-07T10:29:37.41295464+01:00","created_by":"daemon"}]}
{"id":"pretalx-gee","content_hash":"a518f08958b2e54def6d9fd2d16dc4d44bbc8b0203eb6c96a48cfa0de498fc22","title":"Add management command for activity log archival and cleanup","description":"Create a management command to archive or delete old activity log entries to maintain database performance and manage storage for long-running events.","design":"**Problem:**\nActivity logs accumulate over time, especially for long-running events or installations with many events. This can impact:\n- Database size and backup duration\n- Query performance on log-related views\n- General database maintenance overhead\n\n**Solution:**\nCreate a management command that allows administrators to clean up old activity logs based on age and optionally archive them before deletion.\n\n**Implementation:**\n\n1. **Create management command:**\n   - File: src/pretalx/common/management/commands/archive_activity_logs.py\n   - Command name: `archive_activity_logs`\n\n2. **Command functionality:**\n   - Delete logs older than specified age (e.g., --older-than-days=365)\n   - Optional: Archive to JSON file before deletion (--archive-to=path/to/file.json)\n   - Filter by event (--event=slug) or process all events\n   - Dry-run mode to preview what would be deleted\n   - Batch processing for large datasets\n   - Progress display and statistics\n\n3. **Archive format (if used):**\n   - JSON Lines format (one log entry per line)\n   - Include all fields: id, event, person, content_type, object_id, timestamp, action_type, data, is_orga_action\n   - Compress with gzip by default (.jsonl.gz)\n   - Metadata file with archive info (date, event count, entry count)\n\n4. **Safety features:**\n   - Require explicit confirmation for production databases\n   - Never delete logs less than 90 days old (configurable minimum)\n   - Keep at least X most recent logs per object (configurable)\n   - Skip logs that might be needed for compliance (configurable action types)\n\n5. **Command options:**\n   ```bash\n   python manage.py archive_activity_logs \\\\\n     --older-than-days=365 \\\\\n     --event=myconf \\\\\n     --archive-to=/backups/logs/ \\\\\n     --dry-run\n   ```\n\n**Use cases:**\n- Annual cleanup after event completion\n- Regular maintenance for multi-year installations\n- Database size reduction before upgrades\n- Compliance with data retention policies\n\n**Files to create:**\n- src/pretalx/common/management/commands/archive_activity_logs.py\n\n**Reference:**\n- ActivityLog model in src/pretalx/common/models/log.py\n- Existing management commands in src/pretalx/common/management/commands/\n- Consider using Django's bulk_delete for performance","acceptance_criteria":"- Management command created and callable\n- --older-than-days parameter works correctly\n- --event parameter filters to specific event\n- --archive-to exports logs to JSON before deletion\n- --dry-run shows what would be deleted without changes\n- Batch processing handles large datasets efficiently\n- Progress and statistics displayed\n- Safety checks prevent accidental deletion of recent logs\n- Archived files are compressed and include metadata\n- Documentation in command help text\n- Tests verify filtering, archival, and deletion logic","status":"open","priority":3,"issue_type":"feature","created_at":"2025-11-07T10:29:09.244429922+01:00","updated_at":"2025-11-07T10:29:09.244429922+01:00","source_repo":".","dependencies":[{"issue_id":"pretalx-gee","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:09.245838411+01:00","created_by":"daemon"}]}
{"id":"pretalx-mtx","content_hash":"e0cdb286d33b2eb663236386102fe33146b32c61f1846350ecd0fee3ed108e4b","title":"Rename ActivityLog.data to legacy_data and add new JSONField data column","description":"Create database migration to rename the existing TextField 'data' to 'legacy_data' and add a new JSONField 'data' column to the ActivityLog model.","design":"**Current State:**\n- ActivityLog model in src/pretalx/common/models/log.py:43\n- data = models.TextField(null=True, blank=True)\n- json_data cached_property (line 58) parses JSON from the text field\n- log_action() in src/pretalx/common/models/mixins.py:35-67 serializes dicts to JSON strings\n\n**Implementation:**\n1. Create migration that:\n   - Renames 'data' field to 'legacy_data' (TextField)\n   - Adds new 'data' field as JSONField(null=True, blank=True)\n   \n2. Update ActivityLog model (src/pretalx/common/models/log.py):\n   - Change line 43 to: legacy_data = models.TextField(null=True, blank=True)\n   - Add: data = models.JSONField(null=True, blank=True, default=dict)\n   - Keep json_data property but update it to return self.data if exists, else parse legacy_data\n\n3. Update LogMixin.log_action() (src/pretalx/common/models/mixins.py:47-52):\n   - Keep the JSON serialization for backwards compatibility with legacy_data\n   - Store dict directly to new data field\n   - Remove the TypeError check since JSONField handles this\n\n**Do NOT create a data migration** - the migration utility will be a separate task as data migrations are expected to be slow.","acceptance_criteria":"- Migration file created successfully\n- ActivityLog has both legacy_data (TextField) and data (JSONField) fields\n- json_data property returns data field if present, otherwise parses legacy_data\n- log_action() stores data to the new JSONField\n- All existing tests pass\n- No data is lost during migration","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-07T10:29:05.460388307+01:00","updated_at":"2025-11-07T10:15:31.319988941Z","closed_at":"2025-11-07T10:15:31.319988941Z","source_repo":".","dependencies":[{"issue_id":"pretalx-mtx","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:05.461568764+01:00","created_by":"daemon"}]}
{"id":"pretalx-pnz","content_hash":"da333f9b3a4fd30fb147ff147a6526337885d55cd8324b19f55ab7b1661691bf","title":"Add filtering to event activity log list by object type and action type","description":"Add filter controls to the event activity log list view allowing users to filter by object type (submission, user, mail, etc.) and action type (create, update, delete, etc.).","design":"**Current State:**\n- EventHistory view in src/pretalx/orga/views/event.py:278-285\n- Simple ListView, no filtering\n- Template: orga/event/history.html\n- Returns all ActivityLog.objects.filter(event=self.request.event)\n\n**Implementation:**\n\n1. **Analyze existing patterns:**\n   - Check Filterable mixin in src/pretalx/common/views/mixins.py:69-133\n   - See how submission list filtering works (SubmissionFilterForm)\n   - EventHistory should inherit from Filterable or similar\n\n2. **Create filter form:**\n   - Create EventHistoryFilterForm\n   - Fields:\n     - content_type: dropdown of content types that have logs in this event\n     - action_type: dropdown of action types seen in this event\n   - Form should use GET parameters\n\n3. **Update EventHistory view:**\n   - Add filter_fields or use Filterable mixin\n   - Override get_queryset() to apply filters\n   - For content_type: filter by content_type FK\n   - For action_type: filter by action_type field\n   - Handle empty/all case\n\n4. **Update template:**\n   - Add filter form UI to orga/event/history.html\n   - Show active filters with clear buttons\n   - Use pretalx's existing filter styling\n   - Display count of results\n\n5. **Content type display:**\n   - ContentType model references are not user-friendly\n   - Map to readable names: \"Proposal\", \"Speaker\", \"Mail template\", etc.\n   - Use same names as in log_display.py object links\n\n6. **Action type display:**\n   - Raw action types like \"pretalx.submission.create\" are not user-friendly\n   - Use LOG_NAMES from src/pretalx/common/log_display.py:55-140\n   - Group by category (submission actions, mail actions, etc.)\n\n**No search functionality:**\nPer requirements, \"no search, just those filters\"\n\n**Files to create/modify:**\n- Create: src/pretalx/orga/forms/history.py (filter form)\n- Modify: src/pretalx/orga/views/event.py:278-285 (add filtering)\n- Modify: src/pretalx/orga/templates/orga/event/history.html (add filter UI)\n\n**Reference:**\n- Filterable mixin: src/pretalx/common/views/mixins.py:69\n- Submission filtering: look for SubmissionFilterForm usage","acceptance_criteria":"- Filter dropdowns for object type and action type on event history page\n- Filtering works correctly with GET parameters\n- Content types shown with human-readable names\n- Action types shown with human-readable names  \n- Active filters clearly displayed\n- Can clear filters to show all logs\n- Results count updates with filtering\n- URL parameters allow sharing filtered views\n- Tests verify filtering logic\n- Tests verify edge cases (no results, etc.)","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-11-07T10:29:08.83833435+01:00","updated_at":"2025-11-07T22:01:42.683728456Z","closed_at":"2025-11-07T22:01:42.683733603Z","source_repo":".","dependencies":[{"issue_id":"pretalx-pnz","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:08.839321347+01:00","created_by":"daemon"},{"issue_id":"pretalx-pnz","depends_on_id":"pretalx-rob","type":"blocks","created_at":"2025-11-07T10:29:38.009132489+01:00","created_by":"daemon"}]}
{"id":"pretalx-rbb","content_hash":"21b2f9c400265c532102abb2b4599a6c477d5d52a35e7df8ff185a5c1efe8db2","title":"Add 'log/' detail route to API views for object-specific activity logs","description":"Add a 'log/' detail route to API viewsets that returns activity log entries for a specific object, avoiding expensive generic foreign key resolution.","design":"**Current State:**\n- API views in src/pretalx/api/views/\n- PretalxViewSetMixin in src/pretalx/api/mixins.py provides common functionality\n- No current log endpoints in API\n- Generic foreign key resolution is expensive (ContentType lookups)\n\n**Implementation:**\n\n1. **Add detail route decorator:**\n   - Use DRF's @action decorator for detail routes\n   - Add to viewsets that should have log access\n   - Route: /api/events/{event}/{resource}/{pk}/log/\n   - Example: /api/events/myconf/submissions/ABC123/log/\n\n2. **Create log action method:**\n   ```python\n   @action(detail=True, methods=['get'])\n   def log(self, request, **kwargs):\n       obj = self.get_object()\n       # Get logs directly via logged_actions() - no GFK resolution needed\n       logs = obj.logged_actions().all()\n       # Paginate\n       # Serialize\n       return Response(serialized_data)\n   ```\n\n3. **Create ActivityLog serializer:**\n   - New serializer in src/pretalx/api/serializers/\n   - Fields: id, timestamp, person (nested), action_type, data, is_orga_action\n   - Handle legacy_data vs data field\n   - Format data['changes'] readably\n\n4. **Add to relevant viewsets:**\n   - Submission viewset (most important)\n   - User/Speaker viewset\n   - Review viewset\n   - Other models that inherit from PretalxModel with LogMixin\n\n5. **Permission handling:**\n   - Use same permissions as parent viewset\n   - Only users who can view the object can see its logs\n   - Consider if write permission needed (probably yes, for consistency with UI)\n\n6. **Optimization:**\n   - The key benefit is we query via logged_actions() which filters by content_type and object_id directly\n   - No need to resolve content_object on each log entry\n   - Select_related person and event for efficiency\n\n**Files to create/modify:**\n- Create: src/pretalx/api/serializers/log.py (ActivityLogSerializer)\n- Modify: src/pretalx/api/views/submission.py (add log action)\n- Modify: Other viewsets as appropriate\n- Update API docs/schema\n\n**Reference:**\n- DRF detail routes: https://www.django-rest-framework.org/api-guide/viewsets/#marking-extra-actions-for-routing\n- PretalxModel.logged_actions() in src/pretalx/common/models/mixins.py:69-79","acceptance_criteria":"- /log/ detail route available on API viewsets\n- Returns paginated activity log entries for the object\n- Uses logged_actions() method (no expensive GFK resolution)\n- ActivityLogSerializer properly formats log data\n- Permissions match parent viewset permissions\n- Works for submissions, speakers, reviews, etc.\n- API documentation updated\n- Tests verify endpoint returns correct logs\n- Tests verify permission checking","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-07T10:29:08.408947002+01:00","updated_at":"2025-11-07T21:02:10.042341172Z","closed_at":"2025-11-07T21:02:10.042346821Z","source_repo":".","dependencies":[{"issue_id":"pretalx-rbb","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:08.410214202+01:00","created_by":"daemon"},{"issue_id":"pretalx-rbb","depends_on_id":"pretalx-rob","type":"blocks","created_at":"2025-11-07T10:29:37.707125572+01:00","created_by":"daemon"}]}
{"id":"pretalx-rob","content_hash":"2761a67025250a300f1b0b1aa46fecc52744c504a421aecb82fc8b7b3b5d9667","title":"Implement intelligent change tracking in log_action with before/after data","description":"Modify log_action to intelligently detect and log changes to model instances, storing both old and new values in the JSONField data, while preserving special logging behavior for state changes.","design":"**Current Behavior:**\n- log_action() in src/pretalx/common/models/mixins.py:35-67 logs actions but doesn't track what changed\n- Forms call log_action() only if form.has_changed() (see CRUDView.form_valid at src/pretalx/common/views/generic.py:363-365)\n- API serializers call log_action() after save (see PretalxViewSetMixin at src/pretalx/api/mixins.py:57-63)\n- Some models have special state change logging (e.g., submission.accepted, submission.rejected)\n\n**Implementation:**\n\n1. **Enhance log_action() signature and logic:**\n   - Add optional `old_data` and `new_data` parameters\n   - When called with these parameters, store structured change data:\n     ```python\n     {\n       \"changes\": {\n         \"field_name\": {\"old\": old_value, \"new\": new_value},\n         ...\n       }\n     }\n     ```\n\n2. **Add change detection helper:**\n   - Create a method to detect changes between model instances\n   - Use model._meta.fields to iterate through fields\n   - Compare old vs new values\n   - Exclude auto-updated fields (created, updated timestamps)\n   - Handle special field types (I18nField, FileField, etc.)\n\n3. **Update calling sites:**\n   - Modify CRUDView.form_valid() to capture and pass old/new data\n   - Modify PretalxViewSetMixin.perform_update() to capture old state before save\n   - Ensure PretalxViewSetMixin.perform_create() doesn't try to get old state\n   \n4. **Preserve special logging:**\n   - Keep submission state changes (accepted/rejected/etc.) as separate log entries with current behavior\n   - These are logged in specific methods, not via generic save\n   - Reference: check submission model for state change methods\n\n5. **Skip logging when no changes:**\n   - Don't create log entry if old_data == new_data\n   - But still log if explicit data dict is passed (for special actions)\n\n**Key Files:**\n- src/pretalx/common/models/mixins.py:35-67 (log_action)\n- src/pretalx/common/views/generic.py:359-365 (CRUDView.form_valid)\n- src/pretalx/api/mixins.py:57-63 (API update/create)\n- Check existing logging in src/pretalx/orga/views/* for patterns","acceptance_criteria":"- log_action() accepts old_data and new_data parameters\n- Changes are stored in structured format with old/new values\n- No log entry created when no fields actually changed\n- CRUDView automatically captures before/after states\n- API serializers capture before/after states  \n- State change logging preserved as-is\n- Tests cover various field types (text, I18n, foreign keys, etc.)\n- Tests verify no-op saves don't create logs\n- Tests verify special state changes still work","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-07T10:29:06.314653374+01:00","updated_at":"2025-11-07T10:38:37.138978639Z","closed_at":"2025-11-07T10:38:37.138978639Z","source_repo":".","dependencies":[{"issue_id":"pretalx-rob","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:06.315608733+01:00","created_by":"daemon"},{"issue_id":"pretalx-rob","depends_on_id":"pretalx-mtx","type":"blocks","created_at":"2025-11-07T10:29:36.297720305+01:00","created_by":"daemon"}]}
{"id":"pretalx-v76","content_hash":"49ce5ff04b37fa2d3792e7fefe7f0b3fe027314965119c859f80a7f828cba5c5","title":"Create management command to migrate legacy_data to JSONField data","description":"Create a management command that migrates data from ActivityLog.legacy_data (TextField with JSON strings) to ActivityLog.data (JSONField), as this is expected to be a slow operation for large databases.","design":"**Implementation:**\nCreate a management command in src/pretalx/common/management/commands/migrate_activity_logs.py\n\nThe command should:\n1. Find all ActivityLog entries where legacy_data is not null and data is null/empty\n2. Parse JSON from legacy_data\n3. Store parsed dict to data field\n4. Process in batches (e.g., 1000 records at a time) with progress display\n5. Handle JSON parsing errors gracefully (log warnings, skip malformed entries)\n6. Provide --dry-run flag to show what would be migrated\n7. Display statistics: total records, successfully migrated, errors encountered\n\n**Reference:**\n- Existing management commands in src/pretalx/common/management/commands/\n- ActivityLog model in src/pretalx/common/models/log.py\n- Use bulk_update for performance\n\n**Why not a data migration:**\nPer user requirements, this should be a utility function rather than an automatic data migration, as it may be slow for large databases and admins should run it at their convenience.","acceptance_criteria":"- Management command created and callable via python manage.py migrate_activity_logs\n- Command successfully migrates data from legacy_data to data field\n- Batch processing works correctly\n- --dry-run flag shows what would be done without making changes\n- JSON parsing errors are handled gracefully\n- Progress and statistics are displayed\n- Documentation added to command help text","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-07T10:29:05.904191002+01:00","updated_at":"2025-11-07T10:25:23.706443286Z","closed_at":"2025-11-07T10:25:23.706443286Z","source_repo":".","dependencies":[{"issue_id":"pretalx-v76","depends_on_id":"pretalx-yb6","type":"blocks","created_at":"2025-11-07T10:29:05.905313141+01:00","created_by":"daemon"},{"issue_id":"pretalx-v76","depends_on_id":"pretalx-mtx","type":"blocks","created_at":"2025-11-07T10:29:36.025056378+01:00","created_by":"daemon"}]}
{"id":"pretalx-yb6","content_hash":"b4b3051d6878cdc1242ab7cfeccd9ffc8549ce0b7537a6a59d5f16cd64de4446","title":"Enhanced activity logging: Database schema changes and migration utilities","description":"Enhance the activity logging system to track detailed change history with before/after data, add comprehensive UI views, and improve API access to logs.\n\nThis is the parent epic that tracks all work related to enhancing activity logging in pretalx.","design":"The current activity logging system in pretalx uses the ActivityLog model (src/pretalx/common/models/log.py) which logs actions via the LogMixin (src/pretalx/common/models/mixins.py). Currently:\n\n- ActivityLog.data is a TextField storing JSON as strings\n- log_action() accepts a data dict but doesn't track before/after states\n- No detailed change tracking for field modifications\n- Limited visibility into what actually changed\n\nThe enhancement will:\n1. Migrate data field to JSONField for proper structured storage\n2. Log before/after states on model changes\n3. Track question answer changes on parent objects\n4. Add detailed views with diff highlighting\n5. Improve API access to logs\n6. Add filtering capabilities","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-11-07T10:26:14.536143+01:00","updated_at":"2025-11-07T10:22:04.100434136Z","closed_at":"2025-11-07T10:22:04.100434136Z","source_repo":"."}
